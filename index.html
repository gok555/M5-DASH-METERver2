<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M5CAN Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono:wght@400;700&display=swap');
        :root {
            --bg-color: #050505;
            --panel-bg: #1a1a1a;
            --accent-cyan: #00f3ff;
            --accent-red: #ff3333;
            --accent-green: #33ff33;
            --accent-yellow: #ffcc00;
            --text-main: #ffffff;
            --text-dim: #888888;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        /* --- Header / Connection --- */
        header {
            width: 100%;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            position: fixed;
            top: 0;
            z-index: 100;
        }
        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--accent-cyan);
            letter-spacing: 2px;
        }
        #connectBtn {
            background: var(--panel-bg);
            border: 1px solid var(--accent-cyan);
            color: var(--accent-cyan);
            padding: 8px 16px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
        }
        #connectBtn:hover {
            background: var(--accent-cyan);
            color: #000;
            box-shadow: 0 0 10px var(--accent-cyan);
        }
        #connectBtn.connected {
            background: var(--accent-green);
            border-color: var(--accent-green);
            color: #000;
        }
        /* --- Main Dashboard --- */
        .dashboard {
            margin-top: 60px;
            /* Header offset */
            width: 100%;
            max-width: 800px;
            padding: 10px;
            box-sizing: border-box;
            display: grid;
            grid-gap: 15px;
            /* Mobile Layout: Stacked */
            grid-template-columns: 1fr;
        }
        /* --- Gauge Container --- */
        .gauge-container {
            position: relative;
            background: var(--panel-bg);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            min-height: 250px;
        }
        .gauge-label {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 0.9rem;
            color: var(--text-dim);
        }
        /* Canvas for drawing gauges */
        canvas {
            max-width: 100%;
            max-height: 100%;
        }
        /* --- Digital Readouts Grid --- */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* 2 cols */
            gap: 10px;
        }
        .metric-card {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid #333;
            position: relative;
        }
        .metric-title {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .metric-value {
            font-family: 'Roboto Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
        }
        .metric-unit {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 2px;
        }
        /* Specific Colors */
        .val-afr {
            color: var(--accent-yellow);
        }
        .val-iat {
            color: var(--accent-cyan);
        }
        .val-volt {
            color: var(--accent-green);
        }
        .val-egt {
            color: var(--accent-red);
        }
        /* --- Responsive Tweaks --- */
        @media (min-width: 600px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
                /* Side by side on larger screens */
            }
            .gauge-container {
                grid-column: 1 / -1;
                /* Gauge spans full width */
            }
            .metrics-grid {
                grid-column: 1 / -1;
                grid-template-columns: repeat(4, 1fr);
                /* 4 cols */
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>M5CAN DASH</h1>
        <button id="connectBtn">CONNECT</button>
    </header>
    <div class="dashboard">
        <!-- Main RPM / Boost Gauge -->
        <div class="gauge-container" id="mainGaugeContainer">
            <span class="gauge-label">RPM / BOOST(kpa)</span>
            <canvas id="rpmCanvas" width="500" height="300"></canvas>
        </div>
        <!-- Secondary Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <span class="metric-title">AFR</span>
                <span class="metric-value val-afr" id="val-afr">---</span>
                <span class="metric-unit">Lambda/Ratio</span>
            </div>
            <div class="metric-card">
                <span class="metric-title">MAP</span>
                <span class="metric-value" id="val-map">---</span>
                <span class="metric-unit">kPa</span>
            </div>
            <div class="metric-card">
                <span class="metric-title">IAT</span>
                <span class="metric-value val-iat" id="val-iat">---</span>
                <span class="metric-unit">°C</span>
            </div>
            <div class="metric-card">
                <span class="metric-title">VOLT</span>
                <span class="metric-value val-volt" id="val-volt">---</span>
                <span class="metric-unit">V</span>
            </div>
            <div class="metric-card">
                <span class="metric-title">EGT</span>
                <span class="metric-value val-egt" id="val-egt">---</span>
                <span class="metric-unit">°C</span>
            </div>
        </div>
    </div>
    <script>
        // --- Configuration ---
        const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const TX_CHAR_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e"; // Notify (M5 -> Phone)
        // --- State ---
        let bluetoothDevice;
        let bluetoothCharacteristic;
        let data = {
            rpm: 0, map: 0, afr: 0, iat: 0, volt: 0, egt: 0
        };
        // Display values for smoothing
        let displayData = {
            rpm: 0, map: 0
        };
        // --- UI Elements ---
        const connectBtn = document.getElementById('connectBtn');
        const elMap = document.getElementById('val-map');
        const elAfr = document.getElementById('val-afr');
        const elIat = document.getElementById('val-iat');
        const elVolt = document.getElementById('val-volt');
        const elEgt = document.getElementById('val-egt');
        // --- Bluetooth Logic ---
        connectBtn.addEventListener('click', async () => {
            if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                disconnect();
            } else {
                connect();
            }
        });
        async function connect() {
            try {
                console.log('Requesting Bluetooth Device...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'M5CAN' }],
                    optionalServices: [SERVICE_UUID]
                });
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                const server = await bluetoothDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                bluetoothCharacteristic = await service.getCharacteristic(TX_CHAR_UUID);
                await bluetoothCharacteristic.startNotifications();
                bluetoothCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                console.log('Connected!');
                connectBtn.textContent = 'DISCONNECT';
                connectBtn.classList.add('connected');
            } catch (error) {
                console.log('Argh! ' + error);
            }
        }
        function disconnect() {
            if (bluetoothDevice) {
                if (bluetoothDevice.gatt.connected) {
                    bluetoothDevice.gatt.disconnect();
                }
            }
        }
        function onDisconnected(event) {
            console.log('> Bluetooth Device disconnected');
            connectBtn.textContent = 'CONNECT';
            connectBtn.classList.remove('connected');
        }
        function handleNotifications(event) {
            let value = event.target.value;
            let decoder = new TextDecoder('utf-8');
            let str = decoder.decode(value).trim();
            let parts = str.split(',');
            if (parts.length >= 6) {
                data.rpm = parseInt(parts[0]);
                data.map = parseInt(parts[1]);
                data.afr = parseFloat(parts[2]);
                data.iat = parseInt(parts[3]);
                data.volt = parseFloat(parts[4]);
                data.egt = parseInt(parts[5]);
                // Update Text Immediately (No smoothing needed for digits usually, or maybe slight delay)
                updateUIText();
            }
        }
        function updateUIText() {
            // map is smoothened in gauge, but text can be raw or smoothed. Let's use raw for text responsiveness.
            elMap.innerText = data.map;
            elAfr.innerText = data.afr.toFixed(1);
            elIat.innerText = data.iat;
            elVolt.innerText = data.volt.toFixed(1);
            elEgt.innerText = data.egt;
        }
        // --- Gauge Drawing Logic (Canvas) ---
        const canvas = document.getElementById('rpmCanvas');
        const ctx = canvas.getContext('2d');
        // RPM Gauge Config
        const RPM_MAX = 8000;
        const START_ANGLE = Math.PI * 0.8;
        const END_ANGLE = Math.PI * 2.2;
        // Linear Interpolation
        function lerp(start, end, amt) {
            return (1 - amt) * start + amt * end;
        }
        // Animation Loop
        function draw() {
            requestAnimationFrame(draw);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Smoothing
            // 0.1 = slower smooth, 0.3 = faster response
            displayData.rpm = lerp(displayData.rpm, data.rpm, 0.15);
            displayData.map = lerp(displayData.map, data.map, 0.15);
            const cx = canvas.width / 2;
            const cy = canvas.height * 0.7;
            const radius = Math.min(cx, cy) - 20;
            // --- 1. RPM Arc Background ---
            ctx.beginPath();
            ctx.arc(cx, cy, radius, START_ANGLE, END_ANGLE);
            ctx.lineWidth = 20;
            ctx.strokeStyle = '#333';
            ctx.stroke();
            // --- 2. RPM Value Arc ---
            const rpmRatio = Math.min(Math.max(displayData.rpm, 0) / RPM_MAX, 1.0);
            const currentAngle = START_ANGLE + (END_ANGLE - START_ANGLE) * rpmRatio;
            let grad = ctx.createLinearGradient(0, 0, canvas.width, 0);
            grad.addColorStop(0, '#00f3ff');
            grad.addColorStop(0.7, '#33ff33');
            grad.addColorStop(1, '#ff3333');
            ctx.beginPath();
            ctx.arc(cx, cy, radius, START_ANGLE, currentAngle);
            ctx.lineWidth = 20;
            ctx.strokeStyle = grad;
            ctx.stroke();
            // --- 3. Digital RPM Readout ---
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 60px Orbitron';
            ctx.textAlign = 'center';
            // Show smoothed value or raw? Smoothed looks better matching the bar.
            ctx.fillText(Math.round(displayData.rpm), cx, cy);
            ctx.font = '20px Orbitron';
            ctx.fillStyle = '#888';
            ctx.fillText("RPM", cx, cy + 30);
            // --- 4. Boost Bar (Bottom) ---
            // Range: 0kpa to 250kpa
            const barWidth = 300;
            const barHeight = 15;
            const barX = cx - barWidth / 2;
            const barY = cy + 60;
            // Background
            ctx.fillStyle = '#333';
            ctx.fillRect(barX, barY, barWidth, barHeight);
            // Value (Smoothed)
            const mapRatio = Math.min(Math.max(displayData.map, 0) / 250, 1.0);
            ctx.fillStyle = displayData.map > 100 ? '#ffcc00' : '#00f3ff';
            ctx.fillRect(barX, barY, barWidth * mapRatio, barHeight);
            ctx.font = '14px Roboto Mono';
            ctx.fillStyle = '#aaa';
            ctx.fillText("BOOST/MAP", cx, barY + 30);
        }
        // Start drawing
        draw();
    </script>
</body>
</html>
