<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>M5Atom CAN Keypad (Final)</title>
    <style>
        /* Reset & Base */
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            overflow: hidden;
            background-color: #1a1a1a;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            touch-action: manipulation;
        }
        body {
            display: flex;
            flex-direction: column;
        }
        /* --- Views --- */
        .view-container {
            display: none;
            flex: 1;
            flex-direction: column;
            box-sizing: border-box;
            padding: 10px;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .view-container.active {
            display: flex;
        }
        /* --- Main View (Keypad) --- */
        #view-main {
            position: relative;
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 0 5px;
            flex-shrink: 0;
            height: 40px;
        }
        .status-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-indicator {
            font-size: 0.9rem;
            color: #888;
            font-weight: bold;
        }
        .status-indicator.can-ok {
            color: #28a745;
        }
        .status-indicator.can-err {
            color: #dc3545;
        }
        .status-indicator.stalled {
            color: #ffc107;
        }
        .status-indicator.connected {
            color: #28a745;
        }
        .header-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            color: #aaa;
            line-height: 1;
        }
        /* Connect Overlay */
        #connect-overlay {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 40px;
            left: 0;
            bottom: 0;
            background: #1a1a1a;
            z-index: 10;
        }
        #start-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 4px solid #007bff;
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 123, 255, 0.3);
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        #start-btn:active {
            transform: scale(0.95);
            background: rgba(0, 123, 255, 0.3);
        }
        #keypad {
            display: none;
            gap: 8px;
            flex-grow: 1;
            width: 100%;
            max-width: 600px;
            align-self: center;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(4, 1fr);
        }
        #keypad.visible {
            display: grid;
        }
        @media (orientation: landscape) {
            #keypad {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(2, 1fr);
            }
            .main-header {
                margin-bottom: 2px;
                height: 30px;
            }
            #connect-overlay {
                top: 30px;
            }
        }
        .key-btn {
            background: #333;
            border: 3px solid var(--btn-color, #777);
            border-radius: 12px;
            color: var(--btn-color, #fff);
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: relative;
            text-align: center;
            width: 100%;
            height: 100%;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
            font-size: clamp(1rem, 5vw, 2rem);
            transition: all 0.1s ease;
        }
        .key-btn:active,
        .key-btn.pressed {
            transform: scale(0.98);
        }
        .key-btn.active {
            background: var(--btn-color, #006000);
            color: #fff;
            box-shadow: 0 0 15px var(--btn-color, rgba(0, 255, 0, 0.4));
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }
        .key-btn.pressing {
            transform: scale(0.95);
            opacity: 0.8;
        }
        /* --- Settings View --- */
        #view-settings {
            background: #222;
            overflow-y: auto;
            align-items: center;
        }
        .settings-header {
            display: flex;
            width: 100%;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }
        .back-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #fff;
            cursor: pointer;
            padding: 10px;
        }
        .settings-title {
            flex-grow: 1;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .settings-group {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box;
            padding: 0 5px;
        }
        .control-row {
            width: 100%;
        }
        .action-btn {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            color: white;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .btn-blue {
            background: #007bff;
        }
        .btn-gray {
            background: #555;
        }
        .btn-orange {
            background: #e67e22;
        }
        .btn-green {
            background: #28a745;
        }
        .btn-red {
            background: #dc3545;
        }
        .id-input-group {
            display: flex;
            align-items: center;
            background: #333;
            padding: 5px;
            border-radius: 8px;
            gap: 5px;
            width: 100%;
            box-sizing: border-box;
            flex-wrap: nowrap;
        }
        .id-input-group label {
            padding-left: 10px;
            color: #ddd;
            font-size: 1rem;
            white-space: nowrap;
            min-width: 80px;
        }
        #can-id-input,
        #k-meter-id-input,
        #temp-alarm-input {
            flex: 1;
            background: #222;
            border: 1px solid #555;
            color: white;
            padding: 12px;
            border-radius: 4px;
            text-align: center;
            font-family: monospace;
            font-size: 1.2rem;
            min-width: 80px;
        }
        #set-id-btn {
            padding: 12px 20px;
            white-space: nowrap;
            min-width: 80px;
        }
        /* Config List */
        .config-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
        }
        .config-list .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #333;
            padding: 8px 10px;
            border-radius: 6px;
            gap: 5px;
            flex-wrap: wrap;
        }
        .config-name-input {
            flex: 1;
            background: #222;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 16px;
            min-width: 60px;
        }
        /* Mini Segmented Control */
        .mini-switch {
            display: flex;
            background: #222;
            border-radius: 4px;
            padding: 2px;
            gap: 4px;
            flex-shrink: 0;
        }
        .mini-opt {
            border: none;
            background: none;
            color: #666;
            font-size: 0.85rem;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .mini-opt.selected {
            background: #555;
            color: #fff;
            font-weight: bold;
        }
        #log {
            margin-top: 20px;
            width: 100%;
            height: 100px;
            min-height: 100px;
            overflow-y: auto;
            background: #000;
            color: #0f0;
            font-family: monospace;
            font-size: 0.7rem;
            padding: 5px;
            border: 1px solid #444;
            box-sizing: border-box;
        }
        #sync-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 5;
            justify-content: center;
            align-items: center;
            color: #00ff00;
            font-weight: bold;
            font-size: 1.2rem;
        }
        /* Voice Animations */
        @keyframes pulse-mic {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes blink-red {
            0% {
                color: #ff0000;
                text-shadow: 0 0 10px #ff0000;
            }
            50% {
                color: #880000;
                text-shadow: none;
            }
            100% {
                color: #ff0000;
                text-shadow: 0 0 10px #ff0000;
            }
        }
        .temp-warning {
            animation: blink-red 1s infinite;
            font-weight: bold;
            font-size: 1.4rem !important;
        }
        /* --- Meter View --- */
        #view-meter {
            background: #000;
            display: flex;
            /* Changed from default block/flex centering to handle grid */
            flex-direction: column;
            padding-top: 50px;
            /* Space for back button */
            box-sizing: border-box;
        }
        #meter-grid {
            display: grid;
            gap: 8px;
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            /* Default Portrait: 2 columns, 4 rows */
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(4, 1fr);
        }
        /* Landscape Mode */
        @media (orientation: landscape) {
            #meter-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(2, 1fr);
            }
        }
        .meter-cell {
            background: #111;
            border: 2px solid #333;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        .meter-label {
            position: absolute;
            top: 5px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #888;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: bold;
        }
        .meter-value {
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            font-size: clamp(1.5rem, 6vw, 2.5rem);
            color: #fff;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.2);
        }
        .meter-unit {
            position: absolute;
            bottom: 5px;
            right: 10px;
            color: #666;
            font-size: 0.7rem;
        }
        /* Specific Colors */
        .val-green {
            color: #00FF00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.4);
        }
        .val-red {
            color: #FF0000;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.6);
        }
        .val-yellow {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
        }
        .val-cyan {
            color: #00FFFF;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
        }
        .val-gray {
            color: #444;
        }
        .meter-header-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 1.5rem;
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 5px 15px;
            color: white;
            cursor: pointer;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div id="view-meter" class="view-container">
        <button class="meter-header-btn" onclick="showMain()">‚Ü©Ô∏è Back</button>
        <div id="meter-grid">
            <!-- Cell 1: Exhaust Temp -->
            <div class="meter-cell">
                <div class="meter-label">Exhaust Temp</div>
                <div id="meter-val-1" class="meter-value val-cyan">--</div>
                <div class="meter-unit">¬∞C</div>
            </div>
            <!-- Cell 2: Generic Monitor -->
            <div class="meter-cell">
                <div class="meter-label">RX Monitor</div>
                <div id="meter-val-2" class="meter-value val-yellow">---</div>
                <div class="meter-unit">RAW</div>
            </div>
            <!-- Empty Cells 3-8 -->
            <div class="meter-cell">
                <div class="meter-value val-gray">--</div>
            </div>
            <div class="meter-cell">
                <div class="meter-value val-gray">--</div>
            </div>
            <div class="meter-cell">
                <div class="meter-value val-gray">--</div>
            </div>
            <div class="meter-cell">
                <div class="meter-value val-gray">--</div>
            </div>
            <div class="meter-cell">
                <div class="meter-value val-gray">--</div>
            </div>
            <div class="meter-cell">
                <div class="meter-value val-gray">--</div>
            </div>
        </div>
    </div>
    <div id="view-main" class="view-container active">
        <div class="main-header">
            <div class="status-group">
                <div id="status-display" class="status-indicator">üî¥ Disconnected</div>
                <div id="can-status-display" class="status-indicator"
                    style="display:none; font-size:0.8rem; border-left:1px solid #444; padding-left:10px;">CAN: --</div>
            </div>
            <div style="flex:1;"></div>
            <div style="display:flex; gap:15px; align-items:center;">
                <button id="meter-view-btn" class="header-btn" onclick="showMeter()">üìü</button>
                <button id="main-sound-btn" class="header-btn" onclick="toggleSoundMain()"
                    style="font-size:1.2rem;">üîä</button>
                <button class="header-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
                <button id="settings-btn" class="header-btn" onclick="showSettings()">‚öôÔ∏è</button>
            </div>
        </div>
        <div id="connect-overlay">
            <button id="start-btn" onclick="handleStartConnect()">CONNECT<br>START</button>
            <div style="margin-top:20px; color:#666; font-size:0.8rem;">Ver 6.0.0 (Meter View)</div>
        </div>
        <div id="sync-overlay">‚öôÔ∏è Syncing...</div>
        <div id="keypad"></div>
    </div>
    <div id="view-settings" class="view-container">
        <div class="settings-header">
            <button class="back-btn" onclick="showMain()">‚Äπ Back</button>
            <div class="settings-title">Settings</div>
            <div style="width: 50px;"></div>
        </div>
        <div class="settings-group">
            <div class="control-row" id="disconnect-row" style="display:none;">
                <button id="disconnect-btn" class="action-btn btn-red" onclick="disconnect()">üî¥ Disconnect</button>
            </div>
            <div class="control-row">
                <div class="id-input-group">
                    <label style="min-width: 60px;">PAD:0x</label>
                    <input type="text" id="can-id-input" value="100" maxlength="3">
                    <button id="set-id-btn" class="action-btn btn-orange" onclick="setCanId()">SET</button>
                </div>
            </div>
            <div class="control-row" style="margin-top:5px;">
                <div class="id-input-group">
                    <label style="min-width: 60px;">KID:0x</label>
                    <input type="text" id="k-meter-id-input" value="200" maxlength="3">
                    <button id="set-k-id-btn" class="action-btn btn-orange" onclick="setKMeterId()">SET</button>
                </div>
            </div>
            <div class="control-row" style="margin-top:5px;">
                <div class="id-input-group" style="border: 1px solid #d35400;">
                    <label style="min-width: 60px; color: #e67e22;">Alarm:¬∞C</label>
                    <input type="number" id="temp-alarm-input" value="950" placeholder="e.g. 900">
                </div>
                <div style="font-size:0.7rem; color:#888; margin-top:2px; text-align:right;">Voice warning threshold
                </div>
            </div>
            <div class="control-row" style="margin-top: 10px; border-bottom:1px solid #444; padding-bottom:10px;">
                <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px;">Biometric Registration</div>
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                    <div id="bio-status" style="color:#888; font-size:0.8rem;">Checking...</div>
                    <button id="btn-bio-reg" class="action-btn btn-blue" onclick="registerBiometric()"
                        style="padding:10px; font-size:0.9rem; width:auto;">Register</button>
                    <button id="btn-bio-clear" class="action-btn btn-red" onclick="clearBiometric()"
                        style="padding:10px; font-size:0.9rem; width:auto; display:none;">Clear</button>
                </div>
            </div>
            <div class="control-row" style="margin-top: 10px; border-bottom:1px solid #444; padding-bottom:10px;">
                <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px;">Feedback (Haptic/Audio)</div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="color:#ddd; font-size:0.9rem;">Vibra</label>
                    <div class="mini-switch">
                        <button class="mini-opt" id="btn-vibe-on" onclick="setVibe(true)">ON</button>
                        <button class="mini-opt" id="btn-vibe-off" onclick="setVibe(false)">OFF</button>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                    <label style="color:#ddd; font-size:0.9rem;">Sound</label>
                    <div class="mini-switch">
                        <button class="mini-opt" id="btn-sound-on" onclick="setSound(true)">ON</button>
                        <button class="mini-opt" id="btn-sound-off" onclick="setSound(false)">OFF</button>
                    </div>
                </div>
            </div>
            <div class="control-row" style="margin-top: 10px; border-bottom:1px solid #444; padding-bottom:10px;">
                <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px;">Mapping Presets</div>
                <div style="display:flex; gap:10px;">
                    <button class="action-btn btn-gray" onclick="applyPreset('normal')"
                        style="padding:10px; font-size:0.8rem;">Normal (1=0..8=7)</button>
                    <button class="action-btn btn-gray" onclick="applyPreset('reverse')"
                        style="padding:10px; font-size:0.8rem;">Reverse (1=7..8=0)</button>
                </div>
            </div>
            <div class="control-row" style="margin-top: 10px;">
                <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px; margin-left: 5px;">Button Configuration
                </div>
                <div id="config-list-container" class="config-list">
                </div>
            </div>
            <!-- Generic Monitor Config (Moved Inside Settings) -->
            <div class="control-row" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px;">Generic Monitor Config</div>
                <div class="config-row">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <span style="font-size:0.7rem; color:#aaa;">ID (Hex)</span>
                        <input type="text" id="rx-monitor-id-input" value="90" class="config-input" maxlength="3"
                            style="width:60px;">
                    </div>
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <span style="font-size:0.7rem; color:#aaa;">Index</span>
                        <input type="number" id="rx-byte-index-input" value="2" class="config-input" min="0" max="7"
                            style="width:50px;">
                    </div>
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <span style="font-size:0.7rem; color:#aaa;">Mode</span>
                        <select id="rx-mode-select" class="config-input" style="width:80px;">
                            <option value="0">8-bit</option>
                            <option value="1" selected>16-bit LE</option>
                            <option value="2">16-bit BE</option>
                        </select>
                    </div>
                    <button class="action-btn" onclick="setRxConfig()">SET</button>
                </div>
            </div>
            <div class="control-row" style="margin-top: 10px;">
                <button class="action-btn btn-gray" onclick="toggleFullscreen()">‚õ∂ Toggle Fullscreen</button>
            </div>
            <div class="control-row" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                <div style="color: #ccc; font-size: 0.9rem; margin-bottom: 5px; text-align: center;">Config Backup</div>
                <div style="display:flex; gap:10px;">
                    <button class="action-btn btn-blue" onclick="exportConfig()" style="font-size:0.9rem;">‚¨á Save
                        Config</button>
                    <button class="action-btn btn-orange" onclick="importConfig()" style="font-size:0.9rem;">‚¨Ü Load
                        Config</button>
                </div>
                <input type="file" id="import-file" style="display:none" accept=".json"
                    onchange="handleFileSelect(this)">
            </div>
            <div style="color: #666; font-size: 0.8rem; text-align: center; margin-top: 10px;">
                Atom S3 Keypad & Dash Meter Ver 6.3<br>
                M5Atom S3 CAN
            </div>
        </div>
        <pre id="log">Logs...</pre>
    </div>
    <div id="icon-picker-overlay"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:20; justify-content:center; align-items:center;">
        <div
            style="background:#222; padding:20px; border-radius:10px; border:1px solid #555; width:80%; max-width:300px;">
            <div style="text-align:center; margin-bottom:15px; font-weight:bold;">Select Icon</div>
            <div id="icon-picker-grid" style="display:grid; grid-template-columns:repeat(5, 1fr); gap:10px;">
            </div>
            <div style="margin-top:15px; text-align:center;">
                <div style="margin-top:15px; text-align:center;">
                    <button class="action-btn btn-gray" onclick="closeIconPicker()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <div class="control-group">
        <!-- Manange Config Header Removed -->
        <script>
            const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
            const RX_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
            const TX_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
            /* --- ICONS (Ver 3.3) --- */
            const ICONS = {
                none: null,
                power: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>',
                light: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-8.5h-2v3h2V2zm4.25 4.42l1.79 1.79 1.41-1.41-1.79-1.79-1.41 1.41zm5.75 4.08h-3v2h3v-2zm-12 11V6.5h14V17c0 2.21-1.79 4-4 4h-6c-2.21 0-4-1.79-4-4z"/></svg>',
                wiper: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18"/><path d="M5 12l2-6 8 0 2 6"/><path d="M14 6l-2-3"/></svg>', // Simplified
                horn: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 10v4h2l5 5v-14l-5 5H3zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>',
                lock: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>',
                music: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>',
                fan: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19V14.2c-1.21-.63-2-2.16-2-3.2 0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.04-.79 2.57-2 3.2v3.99c1.79-1.04 3-2.97 3-5.19z"/></svg>',
                hazard: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>',
                setting: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84a.484.484 0 0 0-.48.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.27.41.48.41h3.84c.24 0 .44-.17.48-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>',
                engine: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>',
                rain: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 9c0-.8.7-1.5 1.5-1.5S7.5 8.2 7.5 9s-.7 1.5-1.5 1.5S4.5 9.8 4.5 9zm12 0c0-.8.7-1.5 1.5-1.5s1.5.7 1.5 1.5-.7 1.5-1.5 1.5-1.5-.8-1.5-1.5zm-6 0c0-.8.7-1.5 1.5-1.5s1.5.7 1.5 1.5-.7 1.5-1.5 1.5-1.5-.8-1.5-1.5zm-6 6c0-.8.7-1.5 1.5-1.5S7.5 14.2 7.5 15s-.7 1.5-1.5 1.5S4.5 15.8 4.5 15zm12 0c0-.8.7-1.5 1.5-1.5s1.5.7 1.5 1.5-.7 1.5-1.5 1.5-1.5-.8-1.5-1.5zm-6 0c0-.8.7-1.5 1.5-1.5s1.5.7 1.5 1.5-.7 1.5-1.5 1.5-1.5-.8-1.5-1.5z"/></svg>',
                menu: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>',
                ok: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>',
                fuel: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 14h-2V5c0-1.1-.9-2-2-2h-6c-1.1 0-2 .9-2 2v14h10v-5zM9 5h6v9H9V5zm-2 9H5V5h2v9zm13 8h-2v-2h2v2zm0-4h-2v-2h2v2z"/></svg>',
                temp: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 13V5c0-1.66-1.34-3-3-3S9 3.34 9 5v8c-1.21.91-2 2.37-2 4 0 2.76 2.24 5 5 5s5-2.24 5-5c0-1.63-.79-3.09-2-4zm-4-8c0-.55.45-1 1-1s1 .45 1 1h-2z"/></svg>',
                winch: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v7"/><path d="M12 15v7"/><path d="M15 12h7"/><path d="M2 12h7"/></svg>'
            };
            let device, rxChar, txChar, gattServer;
            // Data Storage
            let btnLabels = JSON.parse(localStorage.getItem("btnLabels")) ||
                Array.from({ length: 8 }, (_, i) => `BTN ${i + 1}`);
            let btnOnVals = JSON.parse(localStorage.getItem("btnOnVals")) ||
                Array(8).fill('01'); // Default ON = 0x01
            let btnOffVals = JSON.parse(localStorage.getItem("btnOffVals")) ||
                Array(8).fill('00'); // Default OFF = 0x00
            let btnIcons = JSON.parse(localStorage.getItem("btnIcons")) ||
                Array(8).fill('none'); // Default no icon
            let btnModes = JSON.parse(localStorage.getItem("btnModes")) ||
                Array(8).fill('toggle');
            // Ver 3.0: Per-Button Endianness
            let btnEndian = JSON.parse(localStorage.getItem("btnEndian")) ||
                Array(8).fill('big');
            // Ver 4.0: Biometric Auth
            let btnAuth = JSON.parse(localStorage.getItem("btnAuth")) ||
                Array(8).fill(false);
            // Ver 4.4: Button Delays
            let btnOnDelays = JSON.parse(localStorage.getItem("btnOnDelays")) || Array(8).fill(0);
            let btnOffDelays = JSON.parse(localStorage.getItem("btnOffDelays")) || Array(8).fill(0);
            // Ver 4.1: Auth Credential ID (Local Registration)
            let authCredentialId = localStorage.getItem("authCredentialId");
            // Ver 3.1: Feedback
            let cfgVibe = JSON.parse(localStorage.getItem("cfgVibe")) !== false; // Default true
            let cfgSound = JSON.parse(localStorage.getItem("cfgSound")) !== false; // Default true (Changed from false)
            // ‚òÖ NEW: Temp Alarm Threshold (Stored)
            let tempWarnVal = parseInt(localStorage.getItem("tempWarnVal")) || 950;
            let lastTempWarnTime = 0; // Debounce logic
            // ‚òÖ NEW: Monitor Config (Stored)
            let rxMonitorId = localStorage.getItem("rxMonitorId") || "90";
            let rxByteIndex = localStorage.getItem("rxByteIndex") || "2";
            let rxMode = localStorage.getItem("rxMode") || "1";
            // Audio
            let audioCtx = null;
            let btnColors = JSON.parse(localStorage.getItem("btnColors")) ||
                Array(8).fill('#00FF00');
            let btnStates = Array(8).fill(false);
            let isConnected = false;
            // --- Pulse Logic Variables ---
            let lastPulseTimes = Array(8).fill(0);
            // Ver 4.5: Long Press Timers
            let holdTimers = Array(8).fill(null);
            // --- Watchdog ---
            let watchdogTimer = null;
            const WATCHDOG_TIMEOUT = 3500; // 3.5s (Device sends every 1s)
            // --- CAN ID Logic ---
            let canIdVal = localStorage.getItem("canIdVal") || "100";
            let kMeterIdVal = localStorage.getItem("kMeterIdVal") || "200";
            // Set Init Values to Inputs
            document.addEventListener("DOMContentLoaded", () => {
                const cInput = document.getElementById("can-id-input");
                if (cInput) cInput.value = canIdVal;
                const kInput = document.getElementById("k-meter-id-input");
                if (kInput) kInput.value = kMeterIdVal;
                // ‚òÖ NEW: Init Temp Alarm Input
                const tInput = document.getElementById("temp-alarm-input");
                if (tInput) {
                    tInput.value = tempWarnVal;
                    tInput.addEventListener('change', (e) => {
                        let val = parseInt(e.target.value);
                        if (isNaN(val)) val = 950;
                        tempWarnVal = val;
                        localStorage.setItem("tempWarnVal", tempWarnVal);
                    });
                }
                localStorage.setItem("tempWarnVal", tempWarnVal);
                const rId = document.getElementById("rx-monitor-id-input");
                if (rId) rId.value = rxMonitorId;
                const rIdx = document.getElementById("rx-byte-index-input");
                if (rIdx) rIdx.value = rxByteIndex;
                const rMode = document.getElementById("rx-mode-select");
                if (rMode) rMode.value = rxMode;
            });
            /* --- Config UI Generation --- */
            function renderConfigList() {
                // Update Bio Status UI
                const st = document.getElementById("bio-status");
                const btnReg = document.getElementById("btn-bio-reg");
                const btnClear = document.getElementById("btn-bio-clear");
                if (authCredentialId) {
                    st.textContent = "‚úÖ Registered";
                    st.style.color = "#28a745";
                    btnReg.style.display = "none";
                    btnClear.style.display = "block";
                } else {
                    st.textContent = "‚ö†Ô∏è Not Registered";
                    st.style.color = "#ffc107";
                    btnReg.style.display = "block";
                    btnClear.style.display = "none";
                }
                const container = document.getElementById('config-list-container');
                container.innerHTML = '';
                btnLabels.forEach((label, i) => {
                    const row = document.createElement('div');
                    row.className = 'config-row';
                    const isMom = (btnModes[i] === 'momentary');
                    const color = btnColors[i];
                    const endian = btnEndian[i];
                    const icon = btnIcons[i];
                    const isAuth = btnAuth[i]; // Ver 4.0
                    row.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:2px; align-items:center;">
                  <button class="mini-opt" style="width:30px; height:30px; border:1px solid #555; padding:2px;" onclick="openIconPicker(${i})">
                    ${(icon !== 'none' && ICONS[icon]) ? ICONS[icon] : '<span style="font-size:0.8rem;">Icon</span>'}
                  </button>
                  <input type="color" value="${color}" onchange="updateBtnColor(${i}, this.value)" style="width:30px; height:20px; border:none; background:none; cursor:pointer;">
                </div>
                 
                <input type="text" class="config-name-input" value="${label}" 
                    maxlength="8" onchange="updateBtnLabel(${i}, this.value)">
                <div style="display:flex; flex-direction:column; gap:2px;">
                  <div style="display:flex; gap:2px; align-items:center;">
                    <span style="font-size:0.7rem; color:#aaa;">ON:0x</span>
                    <input type="text" value="${btnOnVals[i]}" maxlength="2" 
                      onchange="updateBtnVal(${i}, 'on', this.value)"
                      style="width:40px; background:#222; border:1px solid #555; color:white; font-family:monospace; text-align:center; padding:4px; font-size:16px;">
                  </div>
                   <div style="display:flex; gap:2px; align-items:center;">
                    <span style="font-size:0.7rem; color:#aaa;">OFF:0x</span>
                    <input type="text" value="${btnOffVals[i]}" maxlength="2" 
                      onchange="updateBtnVal(${i}, 'off', this.value)"
                      style="width:40px; background:#222; border:1px solid #555; color:white; font-family:monospace; text-align:center; padding:4px; font-size:16px;">
                    </div>
                 </div>
                 <button class="action-btn btn-orange" style="padding: 5px 10px; font-size: 0.8rem; width: auto;" onclick="saveBtnConfig(${i})">SET</button>
                 
                 <div style="display:flex; flex-direction:column; gap:2px; margin-left:5px;">
                   <div style="display:flex; gap:2px; align-items:center;">
                     <span style="font-size:0.7rem; color:#aaa;">OnDly</span>
                     <input type="number" value="${btnOnDelays[i]}" step="0.1" min="0" 
                       onchange="updateBtnDelay(${i}, 'on', this.value)"
                       style="width:50px; background:#222; border:1px solid #555; color:white; font-family:monospace; text-align:center; padding:4px; font-size:14px;">
                   </div>
                   <div style="display:flex; gap:2px; align-items:center;">
                     <span style="font-size:0.7rem; color:#aaa;">OffDly</span>
                     <input type="number" value="${btnOffDelays[i]}" step="0.1" min="0" 
                       onchange="updateBtnDelay(${i}, 'off', this.value)"
                       style="width:50px; background:#222; border:1px solid #555; color:white; font-family:monospace; text-align:center; padding:4px; font-size:14px;">
                   </div>
                 </div>
                 
                <div class="mini-switch">
                    <button class="mini-opt ${!isMom ? 'selected' : ''}" onclick="changeBtnMode(${i}, 'toggle')">Tog</button>
                    <button class="mini-opt ${isMom ? 'selected' : ''}" onclick="changeBtnMode(${i}, 'momentary')">Pul</button>
                </div>
                 <div style="display:flex; flex-direction:column; align-items:center; margin-left:5px;">
                   <span style="font-size:0.6rem; color:#888;">Endian</span>
                   <div class="mini-switch">
                     <button class="mini-opt ${endian === 'big' ? 'selected' : ''}" onclick="updateBtnEndian(${i}, 'big')">B</button>
                     <button class="mini-opt ${endian === 'little' ? 'selected' : ''}" onclick="updateBtnEndian(${i}, 'little')">L</button>
                   </div>
                   </div>
                 </div>
                 <div style="display:flex; flex-direction:column; align-items:center; margin-left:5px;">
                   <span style="font-size:0.6rem; color:#888;">${isAuth ? 'Lock' : 'Unlock'}</span>
                   <button class="mini-opt ${isAuth ? 'selected' : ''}" style="width:30px; height:30px; border:1px solid #555; padding:2px;" onclick="toggleBtnAuth(${i})">
                      ${isAuth ? 'üîí' : 'üîì'}
                   </button>
                 </div>
            `;
                    container.appendChild(row);
                });
            }
            function changeBtnMode(index, mode) {
                btnModes[index] = mode;
                localStorage.setItem("btnModes", JSON.stringify(btnModes));
                renderConfigList();
            }
            function updateBtnLabel(index, newName) {
                btnLabels[index] = newName;
                localStorage.setItem("btnLabels", JSON.stringify(btnLabels));
                const labelSpan = document.getElementById(`label-${index + 1}`);
                if (labelSpan) labelSpan.textContent = newName;
            }
            function updateBtnVal(index, type, val) {
                // Validate Hex
                if (!/^[0-9A-Fa-f]{1,2}$/.test(val)) {
                    alert("Invalid Hex");
                    renderConfigList(); // Reset
                    return;
                }
                val = val.toUpperCase().padStart(2, '0'); // Format to 2 chars
                if (type === 'on') {
                    btnOnVals[index] = val;
                    localStorage.setItem("btnOnVals", JSON.stringify(btnOnVals));
                } else {
                    btnOffVals[index] = val;
                    localStorage.setItem("btnOffVals", JSON.stringify(btnOffVals));
                }
                // sendBtnConfig(index); // Removed for manual save
            }
            /* --- SYNC FUNCTION MODIFIED --- */
            async function syncAllBtnConfigs() {
                if (!rxChar) return;
                const overlay = document.getElementById("sync-overlay");
                if (overlay) overlay.style.display = "flex";
                log("Syncing Config to Device...");
                for (let i = 0; i < 8; i++) {
                    sendBtnConfig(i);
                    await new Promise(r => setTimeout(r, 150)); // Small delay
                    // Also send current state (OFF value) to ensure RAM is correct
                    sendState(i + 1, btnStates[i]);
                    await new Promise(r => setTimeout(r, 150));
                }
                if (overlay) overlay.style.display = "none";
                log("Config Sync Complete");
            }
            function saveBtnConfig(index) {
                sendBtnConfig(index);
                alert(`Button ${index + 1} „ÅÆON/OFFË®≠ÂÆö„Çí„Éá„Éê„Ç§„Çπ„Å´‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ`);
            }
            function sendBtnConfig(inIdx) {
                if (!rxChar) return;
                // Get values
                const onValRaw = btnOnVals[inIdx];
                const offValRaw = btnOffVals[inIdx];
                // Convert Hex to Decimal for transmission
                const onVal = parseInt(onValRaw, 16);
                const offVal = parseInt(offValRaw, 16);
                if (isNaN(onVal) || isNaN(offVal)) return;
                const cmd = `CFGBTN=${inIdx},${onVal},${offVal}`;
                rxChar.writeValue(new TextEncoder().encode(cmd))
                    .catch(e => console.log("TX Config Err"));
            }
            function updateBtnDelay(index, type, val) {
                let v = parseFloat(val);
                if (isNaN(v) || v < 0) v = 0;
                if (type === 'on') {
                    btnOnDelays[index] = v;
                    localStorage.setItem("btnOnDelays", JSON.stringify(btnOnDelays));
                } else {
                    btnOffDelays[index] = v;
                    localStorage.setItem("btnOffDelays", JSON.stringify(btnOffDelays));
                }
            }
            function updateBtnColor(index, newColor) {
                btnColors[index] = newColor;
                localStorage.setItem("btnColors", JSON.stringify(btnColors));
                const btn = document.getElementById(`btn-${index + 1}`);
                if (btn) {
                    btn.style.setProperty('--btn-color', newColor);
                }
            }
            /* --- Endian Logic (Ver 3.0) --- */
            function updateBtnEndian(index, mode) {
                btnEndian[index] = mode;
                localStorage.setItem("btnEndian", JSON.stringify(btnEndian));
                renderConfigList();
            }
            function applyPreset(type) {
                if (type === 'normal') {
                    btnEndian = Array(8).fill('big');
                } else {
                    btnEndian = Array(8).fill('little');
                }
                localStorage.setItem("btnEndian", JSON.stringify(btnEndian));
                renderConfigList();
            }
            /* --- Auth Logic (Ver 4.0) --- */
            async function toggleBtnAuth(index) {
                // Ver 4.2: Require Auth to Unlock
                if (btnAuth[index]) {
                    // Currently Locked -> Unlocking
                    const authResult = await checkBiometricAuth();
                    if (!authResult) {
                        alert("ÁôΩ Authentication Failed. Cannot Unlock.");
                        return;
                    }
                }
                btnAuth[index] = !btnAuth[index];
                localStorage.setItem("btnAuth", JSON.stringify(btnAuth));
                renderConfigList();
            }
            // Ver 4.1: Biometric Registration Logic
            // Converts an ArrayBuffer to a Base64 URL-safe string
            function bufferToBase64(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
            }
            // Converts a Base64 URL-safe string to an ArrayBuffer
            function base64ToBuffer(base64) {
                const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                return bytes.buffer;
            }
            async function registerBiometric() {
                if (!window.PublicKeyCredential) {
                    alert("WebAuthn not supported.");
                    return;
                }
                try {
                    const challenge = new Uint8Array(32);
                    window.crypto.getRandomValues(challenge);
                    const publicKey = {
                        challenge: challenge,
                        rp: { name: "M5Atom CAN Keypad", id: window.location.hostname },
                        user: {
                            id: new Uint8Array(16), // Dummy user ID
                            name: "user@local",
                            displayName: "Local User"
                        },
                        pubKeyCredParams: [{ alg: -7, type: "public-key" }, { alg: -257, type: "public-key" }],
                        authenticatorSelection: {
                            authenticatorAttachment: "platform", // FaceID / TouchID
                            userVerification: "required"
                        },
                        timeout: 60000,
                        attestation: "none"
                    };
                    const credential = await navigator.credentials.create({ publicKey });
                    // Save Credential ID
                    const credId = bufferToBase64(credential.rawId);
                    localStorage.setItem("authCredentialId", credId);
                    authCredentialId = credId;
                    alert("Biometric Registered Successfully! üîì -> üîí");
                    renderConfigList(); // Update UI
                } catch (err) {
                    console.error("Registration failed", err);
                    alert("Registration Failed: " + err.message);
                }
            }
            async function clearBiometric() {
                // Ver 4.2: Require Auth to Clear
                const authResult = await checkBiometricAuth();
                if (!authResult) {
                    alert("ÁôΩ Authentication Failed. Cannot Clear.");
                    return;
                }
                if (confirm("Clear registered biometric data?")) {
                    localStorage.removeItem("authCredentialId");
                    authCredentialId = null;
                    renderConfigList();
                }
            }
            async function checkBiometricAuth() {
                if (!window.PublicKeyCredential) {
                    alert("Biometric authentication not supported on this device/browser.");
                    return false;
                }
                // Ver 4.1: Check if registered
                if (!authCredentialId) {
                    alert("Biometric not registered. Please register in Settings.");
                    return false;
                }
                try {
                    const challenge = new Uint8Array(32);
                    window.crypto.getRandomValues(challenge);
                    const publicKeyCredentialRequestOptions = {
                        challenge: challenge,
                        timeout: 60000,
                        userVerification: "required",
                        rpId: window.location.hostname,
                        allowCredentials: [{
                            id: base64ToBuffer(authCredentialId),
                            type: 'public-key',
                            transports: ['internal']
                        }]
                    };
                    const credential = await navigator.credentials.get({
                        publicKey: publicKeyCredentialRequestOptions
                    });
                    if (credential) {
                        return true;
                    }
                } catch (err) {
                    console.error("Auth failed", err);
                }
                return false;
            }
            /* --- Feedback Logic (Ver 3.1) --- */
            function setVibe(state) {
                cfgVibe = state;
                localStorage.setItem("cfgVibe", JSON.stringify(cfgVibe));
                updateFeedbackUI();
            }
            function setSound(state) {
                cfgSound = state;
                localStorage.setItem("cfgSound", JSON.stringify(cfgSound));
                updateFeedbackUI();
                if (state) initAudio();
            }
            function updateFeedbackUI() {
                const vo = document.getElementById('btn-vibe-on');
                const vf = document.getElementById('btn-vibe-off');
                if (vo && vf) {
                    vo.className = `mini-opt ${cfgVibe ? 'selected' : ''}`;
                    vf.className = `mini-opt ${!cfgVibe ? 'selected' : ''}`;
                }
                const so = document.getElementById('btn-sound-on');
                const sf = document.getElementById('btn-sound-off');
                if (so && sf) {
                    so.className = `mini-opt ${cfgSound ? 'selected' : ''}`;
                    sf.className = `mini-opt ${!cfgSound ? 'selected' : ''}`;
                }
            }
            /* --- Icon Picker Logic (Ver 3.3) --- */
            let currentIconBtnIndex = -1;
            function openIconPicker(index) {
                currentIconBtnIndex = index;
                const overlay = document.getElementById('icon-picker-overlay');
                const grid = document.getElementById('icon-picker-grid');
                // Generate Grid Content dynamically to render SVGs
                let html = `<button onclick="selectIcon('none')" style="padding:10px; background:#444; border:none; color:white; border-radius:5px;">TXT</button>`;
                // Iterate over ICONS (skip 'none')
                for (const [key, svg] of Object.entries(ICONS)) {
                    if (key === 'none') continue;
                    html += `<button onclick="selectIcon('${key}')" style="padding:5px; background:none; border:1px solid #444; color:white; border-radius:5px; height:40px; width:40px;">${svg}</button>`;
                }
                grid.innerHTML = html;
                overlay.style.display = 'flex';
            }
            function closeIconPicker() {
                document.getElementById('icon-picker-overlay').style.display = 'none';
            }
            function selectIcon(iconKey) {
                if (currentIconBtnIndex >= 0) {
                    btnIcons[currentIconBtnIndex] = iconKey;
                    localStorage.setItem("btnIcons", JSON.stringify(btnIcons));
                    renderConfigList();
                    renderKeypadGrid(); // Update Main View immediately
                    closeIconPicker();
                }
            }
            /* --- Screen Wake Lock Logic (Ver 1.2 Fixed) --- */
            let wakeLock = null;
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('Wake Lock is active!');
                        wakeLock.addEventListener('release', () => {
                            console.log('Wake Lock released');
                        });
                    }
                } catch (err) {
                    console.error(`Wake Lock Error: ${err.name}, ${err.message}`);
                }
            }
            // Re-acquire lock when visibility changes (if it was dropped)
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    await requestWakeLock();
                }
            });
            function initAudio() {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                } else if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            }
            function triggerFeedback() {
                // Vibe
                if (cfgVibe && navigator.vibrate) {
                    navigator.vibrate(15);
                }
                // Sound
                if (cfgSound && audioCtx) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.type = 'square';
                    osc.frequency.value = 2000;
                    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                    osc.start();
                    osc.stop(audioCtx.currentTime + 0.05);
                }
            }
            /* --- Fullscreen Logic --- */
            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => {
                        // log("FS Err: " + e); // Common if not user gesture
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            }
            function enterFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(e => {
                        // log("FS IGNORED");
                    });
                }
            }
            /* --- Navigation --- */
            /* --- Navigation --- */
            function showSettings() {
                renderConfigList();
                updateFeedbackUI();
                document.getElementById("view-main").classList.remove("active");
                document.getElementById("view-meter").classList.remove("active");
                document.getElementById("view-settings").classList.add("active");
            }
            function showMain() {
                // Force Hide Others
                document.getElementById("view-settings").style.display = "none";
                document.getElementById("view-meter").style.display = "none";
                document.getElementById("view-settings").classList.remove("active");
                document.getElementById("view-meter").classList.remove("active");
                // Show Main
                const v = document.getElementById("view-main");
                v.style.display = "flex";
                v.classList.add("active");
            }
            function showMeter() {
                // Force Hide Others
                document.getElementById("view-main").style.display = "none";
                document.getElementById("view-settings").style.display = "none";
                document.getElementById("view-main").classList.remove("active");
                document.getElementById("view-settings").classList.remove("active");
                // Show Meter
                const v = document.getElementById("view-meter");
                v.style.display = "flex";
                v.classList.add("active");
            }
            function showSettings() {
                // Force Hide Others
                document.getElementById("view-main").style.display = "none";
                document.getElementById("view-meter").style.display = "none";
                document.getElementById("view-main").classList.remove("active");
                document.getElementById("view-meter").classList.remove("active");
                // Show Settings
                const v = document.getElementById("view-settings");
                v.style.display = "flex";
                v.classList.add("active");
            }
            function log(t) {
                const el = document.getElementById("log");
                const time = new Date().toLocaleTimeString().split(' ')[0];
                el.textContent = `[${time}] ${t}\n` + el.textContent.substring(0, 1000);
            }
            function updateStatus(connected) {
                isConnected = connected;
                const ind = document.getElementById("status-display");
                const overlay = document.getElementById("connect-overlay");
                const keypad = document.getElementById("keypad");
                const discRow = document.getElementById("disconnect-row");
                if (connected) {
                    ind.textContent = "üü¢ BLE";
                    ind.classList.add("connected");
                    // Show Keypad, Hide Overlay
                    overlay.style.display = "none";
                    keypad.classList.add("visible");
                    // Show Disconnect option in settings
                    discRow.style.display = "flex";
                    // Start waiting for heartbeat
                    resetWatchdog();
                    document.getElementById("can-status-display").style.display = "block";
                    updateMainSoundIcon();
                } else {
                    ind.textContent = "üî¥ Disconnected";
                    ind.classList.remove("connected");
                    ind.classList.remove("stalled");
                    // Hide Keypad, Show Overlay
                    overlay.style.display = "flex";
                    keypad.classList.remove("visible");
                    // Hide Disconnect option
                    discRow.style.display = "none";
                    document.getElementById("can-status-display").style.display = "none";
                    clearTimeout(watchdogTimer);
                }
            }
            function resetWatchdog() {
                if (!isConnected) return;
                const ind = document.getElementById("status-display");
                // Restore "Connected" visual if it was stalled
                if (ind.textContent.includes("No Resp")) {
                    ind.textContent = "üü¢ BLE";
                    ind.style.color = "#00ff00"; // Green
                    ind.style.borderColor = "#00ff00";
                    ind.classList.remove("stalled");
                    ind.classList.add("connected");
                }
                clearTimeout(watchdogTimer);
                watchdogTimer = setTimeout(() => {
                    // Heartbeat lost
                    ind.textContent = "‚ö†Ô∏è No Resp";
                    ind.style.color = "orange";
                    ind.style.borderColor = "orange"; // Orange
                    ind.classList.remove("connected");
                    ind.classList.add("stalled");
                    // Optional: Auto disconnect logic? For now just visual warning.
                }, WATCHDOG_TIMEOUT);
            }
            function updateCanStatus(st) {
                const el = document.getElementById("can-status-display");
                if (!el) return;
                // Ensure visible
                if (el.style.display === "none") el.style.display = "block";
                if (st === "CAN_OK") {
                    el.textContent = "CAN: OK";
                    el.className = "status-indicator can-ok";
                    el.style.color = "#00ff00"; // Force Green
                    el.style.borderColor = "#00ff00";
                } else {
                    el.textContent = "CAN: ERR";
                    el.className = "status-indicator can-err";
                    el.style.color = "#ff0000"; // Force Red
                    el.style.borderColor = "#ff0000";
                }
            }
            // --- CONNECT FLOW (Composite Action) ---
            async function handleStartConnect() {
                initAudio();
                // 1. Enter Fullscreen (User Gesture)
                enterFullscreen();
                // 2. Request Wake Lock (User Gesture)
                // Note: We do NOT await this. We let it fire in the background.
                // Awaiting it might delay the 'connect()' call enough to lose the "User Gesture" token required for popups.
                requestWakeLock();
                // 3. Start BLE Connect (User Gesture - Must happen immediately)
                await connect();
            }
            async function connect() {
                try {
                    device = await navigator.bluetooth.requestDevice({
                        filters: [{
                            namePrefix: 'M5'
                        }],
                        optionalServices: [SERVICE_UUID]
                    });
                    gattServer = await device.gatt.connect();
                    device.addEventListener('gattserverdisconnected', () => {
                        log("Disconnected Event");
                        updateStatus(false);
                    });
                    const svc = await gattServer.getPrimaryService(SERVICE_UUID);
                    rxChar = await svc.getCharacteristic(RX_UUID);
                    txChar = await svc.getCharacteristic(TX_UUID);
                    await txChar.startNotifications();
                    txChar.addEventListener('characteristicvaluechanged', handleNotifications);
                    // Fix: Force Main View to clear any overlapping elements on initial load
                    showMain();
                    updateStatus(true);
                    log("BLE Ready");
                    // Sync Config Automatically
                    setTimeout(syncAllBtnConfigs, 500);
                } catch (e) {
                    log("Err: " + e);
                    updateStatus(false);
                }
            }
            function disconnect() {
                if (device && device.gatt.connected) {
                    device.gatt.disconnect();
                    updateStatus(false);
                }
            }
            function handleNotifications(event) {
                const decoder = new TextDecoder('utf-8');
                const cmd = decoder.decode(event.target.value);
                // Clean up string
                const cleanedCmd = cmd.replace(/(\r\n|\n|\r)/gm, "").trim();
                log("RX: " + cleanedCmd);
                // Reset watchdog on ANY message from device
                resetWatchdog();
                if (cleanedCmd.startsWith("ID=")) {
                    const val = cleanedCmd.split("=")[1];
                    // Remove 0x if present for cleaner UI
                    const cleanVal = val.replace("0x", "").replace("0X", "").toUpperCase();
                    log("Sync ID: " + cleanVal);
                    canIdVal = cleanVal;
                    localStorage.setItem("canIdVal", canIdVal);
                    // Update Input if exists
                    const el = document.getElementById("can-id-input");
                    if (el) el.value = canIdVal;
                }
                else if (cleanedCmd.startsWith("KID=")) {
                    const val = cleanedCmd.split("=")[1];
                    const cleanVal = val.replace("0x", "").replace("0X", "").toUpperCase();
                    log("Sync KID: " + cleanVal);
                    kMeterIdVal = cleanVal;
                    localStorage.setItem("kMeterIdVal", kMeterIdVal);
                    // Update Input if exists
                    const el = document.getElementById("k-meter-id-input");
                    if (el) el.value = kMeterIdVal;
                }
                else if (cleanedCmd.startsWith("VAL=")) {
                    const val = cleanedCmd.split("=")[1];
                    // Update Grid Cell 2 (Generic Monitor)
                    const el = document.getElementById("meter-val-2");
                    if (el) {
                        el.textContent = val;
                        // Flash effect
                        el.style.color = "#FFF";
                        setTimeout(() => el.style.color = "#FFD700", 100);
                    }
                }
                else if (cleanedCmd.startsWith("TEMP=")) {
                    const val = cleanedCmd.split("=")[1];
                    // Update Grid Cell 1 (Exhaust Temp)
                    const el = document.getElementById("meter-val-1");
                    if (el) {
                        el.textContent = val;
                        // Temp Warning Logic
                        let tempVal = parseInt(val);
                        if (!isNaN(tempVal) && tempVal >= tempWarnVal) {
                            el.classList.add("temp-warning");
                            el.classList.remove("val-cyan");
                            el.classList.add("val-red");
                            if (Date.now() - lastTempWarnTime > 5000) {
                                playVoice("warning-temp");
                                lastTempWarnTime = Date.now();
                            }
                        } else {
                            el.classList.remove("temp-warning");
                            el.classList.remove("val-red");
                            el.classList.add("val-cyan");
                        }
                    }
                }
                else if (cleanedCmd.startsWith("STATE=")) {
                    const states = cleanedCmd.substring(6).split(',');
                    if (states.length >= 8) {
                        const now = Date.now();
                        // Ver 3.2: Iterate Buttons (Fixed Index, Bit Reverse Logic)
                        for (let i = 0; i < 8; i++) {
                            const s = states[i];
                            if (s === undefined) continue;
                            if (btnModes[i] === 'momentary') {
                                if (now - lastPulseTimes[i] < 500) {
                                    continue; // Ignore sync
                                }
                            }
                            // Version 2.7 Logic preserved
                            let receivedVal = parseInt(s, 10);
                            // Ver 3.2: Reverse Bits if Little Endian
                            if (btnEndian[i] === 'little') {
                                receivedVal = reverseBits(receivedVal);
                            }
                            const onVal = parseInt(btnOnVals[i], 16);
                            btnStates[i] = (receivedVal === onVal);
                            updateBtnVisual(i + 1, btnStates[i]);
                        }
                    }
                } else if (cleanedCmd.startsWith("STATUS=")) {
                    const st = cleanedCmd.substring(7);
                    updateCanStatus(st);
                }
            }
            /* --- Bit Reverse Helper --- */
            function reverseBits(n) {
                let r = 0;
                for (let i = 0; i < 8; i++) {
                    r = (r << 1) | (n & 1);
                    n >>= 1;
                }
                return r >>> 0;
            }
            function updateBtnVisual(btnId, isOn) {
                const btn = document.getElementById(`btn-${btnId}`);
                if (btn) {
                    if (isOn) btn.classList.add("active");
                    else btn.classList.remove("active");
                }
            }
            /* --- Button Actions --- */
            function handleBtnPress(btnIndex) {
                if (!rxChar) return; // Ignore if not connected
                // Ver 4.2: Auth Check
                if (btnAuth[btnIndex]) {
                    // Logic: If Locked, we might need auth to actuate?
                    // User requirement: "Once authenticated, it toggles lock state".
                    // If the button is just "Locked", maybe it cannot be pressed?
                    // For now, let's assume 'Lock' just prevents CONFIG changes, not actuation.
                    // OR: asking for auth on every press? 
                    // Let's implement: Auth prevents actuation if locked.
                    // checkBiometricAuth().then(ok => { if(ok) doActuate... });
                    // For speed, we will skip auth on actuation for now, assuming Lock is for Config protection.
                }
                const now = Date.now();
                lastPulseTimes[btnIndex] = now;
                const mode = btnModes[btnIndex];
                if (mode === 'toggle') {
                    // Toggle State
                    const newState = !btnStates[btnIndex];
                    btnStates[btnIndex] = newState;
                    updateBtnVisual(btnIndex + 1, newState);
                    // Send Command
                    sendState(btnIndex + 1, newState);
                } else {
                    // Momentary Press (ON)
                    btnStates[btnIndex] = true;
                    updateBtnVisual(btnIndex + 1, true);
                    const btn = document.getElementById(`btn-${btnIndex + 1}`);
                    if (btn) btn.classList.add("pressing");
                    sendState(btnIndex + 1, true);
                    // Ver 4.5: Long Press Logic start
                    // If we want to support 'Hold for 3s', we track start time.
                    // For standard momentary: OFF is sent on Release.
                }
            }
            function handleBtnRelease(btnIndex) {
                if (!rxChar) return;
                const mode = btnModes[btnIndex];
                if (mode === 'momentary') {
                    // Momentary Release (OFF)
                    btnStates[btnIndex] = false;
                    updateBtnVisual(btnIndex + 1, false);
                    const btn = document.getElementById(`btn-${btnIndex + 1}`);
                    if (btn) btn.classList.remove("pressing");
                    sendState(btnIndex + 1, false);
                }
            }
            // Send State Command
            function sendState(btnId, isOn) {
                if (!rxChar) return;
                const idx = btnId - 1;
                const valRaw = isOn ? btnOnVals[idx] : btnOffVals[idx];
                const endian = btnEndian[idx];
                let val = parseInt(valRaw, 16);
                // Ver 3.0: Reverse if Little Endian
                if (endian === 'little') {
                    val = reverseBits(val);
                }
                const cmd = `BTN=${btnId},${val}`;
                rxChar.writeValue(new TextEncoder().encode(cmd))
                    .catch(e => console.log("TX Err"));
                // Ver 4.4: Delays
                const delay = isOn ? btnOnDelays[idx] : btnOffDelays[idx];
                if (delay > 0) {
                    log(`Delay ${delay}s...`);
                }
                triggerFeedback();
            }
            /* --- Voice / Audio (Ver 5.0) --- */
            function playVoice(type) {
                // Simple placeholder for Web Speech API or Audio File
                if ('speechSynthesis' in window) {
                    const msg = new SpeechSynthesisUtterance();
                    if (type === 'connected') msg.text = "Connected";
                    if (type === 'warning-temp') msg.text = "Warning. High Exhaust Temperature.";
                    window.speechSynthesis.speak(msg);
                }
            }
            /* --- Main Sound Toggle --- */
            function toggleSoundMain() {
                cfgSound = !cfgSound;
                localStorage.setItem("cfgSound", JSON.stringify(cfgSound));
                updateMainSoundIcon();
                if (cfgSound) initAudio();
            }
            function updateMainSoundIcon() {
                const btn = document.getElementById("main-sound-btn");
                if (btn) {
                    btn.textContent = cfgSound ? "üîä" : "üîá";
                    btn.style.opacity = cfgSound ? "1" : "0.5";
                }
            }
            /* --- SET IO Config --- */
            function setCanId() {
                const el = document.getElementById("can-id-input");
                let val = el.value.trim();
                // Basic Validation
                if (!/^[0-9A-Fa-f]{1,3}$/.test(val)) {
                    alert("Invalid Hex ID (1-3 chars)");
                    return;
                }
                val = val.toUpperCase();
                // Send to Device
                if (rxChar) {
                    const cmd = `ID=${val}`;
                    rxChar.writeValue(new TextEncoder().encode(cmd))
                        .then(() => {
                            log(`Set ID=${val}`);
                            canIdVal = val;
                            localStorage.setItem("canIdVal", val);
                            alert("CAN ID updated. Device may restart or reload.");
                        })
                        .catch(e => log("TX ID Err"));
                } else {
                    alert("Not Connected");
                }
            }
            function setKMeterId() {
                const el = document.getElementById("k-meter-id-input");
                let val = el.value.trim();
                if (!/^[0-9A-Fa-f]{1,3}$/.test(val)) {
                    alert("Invalid Hex ID");
                    return;
                }
                val = val.toUpperCase();
                if (rxChar) {
                    const cmd = `KID=${val}`;
                    rxChar.writeValue(new TextEncoder().encode(cmd))
                        .then(() => {
                            log(`Set KID=${val}`);
                            kMeterIdVal = val;
                            localStorage.setItem("kMeterIdVal", val);
                            alert("K-Meter ID updated.");
                        })
                        .catch(e => log("TX KID Err"));
                } else {
                    alert("Not Connected");
                }
            }
            // ‚òÖ Ver 3.20 FIXED for Monitor ID
            function setRxConfig() {
                const idEl = document.getElementById("rx-monitor-id-input");
                const idxEl = document.getElementById("rx-byte-index-input");
                const modeEl = document.getElementById("rx-mode-select");
                let idVal = idEl.value.trim().toUpperCase();
                let idxVal = idxEl.value;
                let modeVal = modeEl.value;
                if (!/^[0-9A-Fa-f]{1,3}$/.test(idVal)) {
                    alert("Invalid RX Monitor ID");
                    return;
                }
                if (rxChar) {
                    // Send: SET_RX=ID(Hex),IDX,MODE
                    // Fix: Do NOT parse to int/decimal. Send raw Hex string.
                    // const idDec = parseInt(idVal, 16); // REMOVED
                    const cmd = `SET_RX=${idVal},${idxVal},${modeVal}`;
                    rxChar.writeValue(new TextEncoder().encode(cmd))
                        .then(() => {
                            log(`Sent: ${cmd}`);
                            // Save to local storage
                            localStorage.setItem("rxMonitorId", idVal);
                            localStorage.setItem("rxByteIndex", idxVal);
                            localStorage.setItem("rxMode", modeVal);
                            alert("RX Monitor Configured.");
                        })
                        .catch(e => log("TX RxConfig Err: " + e));
                } else {
                    alert("Not Connected");
                }
            }
            /* --- Backup / Restore --- */
            function exportConfig() {
                const config = {
                    ver: "6.0",
                    btnLabels,
                    btnOnVals,
                    btnOffVals,
                    btnIcons,
                    btnModes,
                    btnEndian,
                    btnColors,
                    btnOnDelays,
                    btnOffDelays,
                    canIdVal,
                    kMeterIdVal,
                    rxMonitorId,
                    rxByteIndex,
                    rxMode,
                    tempWarnVal
                };
                const blob = new Blob([JSON.stringify(config, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "m5_can_config.json";
                a.click();
            }
            function importConfig() {
                document.getElementById('import-file').click();
            }
            function handleFileSelect(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const c = JSON.parse(e.target.result);
                        if (c.btnLabels) {
                            btnLabels = c.btnLabels;
                            btnOnVals = c.btnOnVals;
                            btnOffVals = c.btnOffVals;
                            btnIcons = c.btnIcons;
                            btnModes = c.btnModes;
                            btnEndian = c.btnEndian;
                            btnColors = c.btnColors;
                            if (c.btnOnDelays) btnOnDelays = c.btnOnDelays;
                            if (c.btnOffDelays) btnOffDelays = c.btnOffDelays;
                            if (c.canIdVal) canIdVal = c.canIdVal;
                            if (c.kMeterIdVal) kMeterIdVal = c.kMeterIdVal;
                            if (c.rxMonitorId) rxMonitorId = c.rxMonitorId;
                            if (c.rxByteIndex) rxByteIndex = c.rxByteIndex;
                            if (c.rxMode) rxMode = c.rxMode;
                            if (c.tempWarnVal) tempWarnVal = c.tempWarnVal;
                            // Save all
                            localStorage.setItem("btnLabels", JSON.stringify(btnLabels));
                            localStorage.setItem("btnOnVals", JSON.stringify(btnOnVals));
                            localStorage.setItem("btnOffVals", JSON.stringify(btnOffVals));
                            localStorage.setItem("btnIcons", JSON.stringify(btnIcons));
                            localStorage.setItem("btnModes", JSON.stringify(btnModes));
                            localStorage.setItem("btnEndian", JSON.stringify(btnEndian));
                            localStorage.setItem("btnColors", JSON.stringify(btnColors));
                            localStorage.setItem("btnOnDelays", JSON.stringify(btnOnDelays));
                            localStorage.setItem("btnOffDelays", JSON.stringify(btnOffDelays));
                            localStorage.setItem("canIdVal", canIdVal);
                            localStorage.setItem("kMeterIdVal", kMeterIdVal);
                            localStorage.setItem("rxMonitorId", rxMonitorId);
                            localStorage.setItem("rxByteIndex", rxByteIndex);
                            localStorage.setItem("rxMode", rxMode);
                            localStorage.setItem("tempWarnVal", tempWarnVal);
                            alert("Config Loaded!");
                            location.reload();
                        }
                    } catch (err) {
                        alert("Invalid Config File");
                    }
                };
                reader.readAsText(file);
            }
            /* --- Grid Generation --- */
            function renderKeypadGrid() {
                const grid = document.getElementById("keypad");
                grid.innerHTML = "";
                for (let i = 0; i < 8; i++) {
                    const btn = document.createElement("button");
                    btn.className = "key-btn";
                    btn.id = `btn-${i + 1}`;
                    btn.style.setProperty('--btn-color', btnColors[i]);
                    // Label
                    const lbl = document.createElement("span");
                    lbl.id = `label-${i + 1}`;
                    lbl.textContent = btnLabels[i];
                    lbl.style.zIndex = "2";
                    // Icon
                    const iconKey = btnIcons[i];
                    if (iconKey && iconKey !== 'none' && ICONS[iconKey]) {
                        const ico = document.createElement("div");
                        ico.innerHTML = ICONS[iconKey];
                        ico.style.width = "40px";
                        ico.style.height = "40px";
                        ico.style.marginBottom = "5px";
                        ico.style.zIndex = "2";
                        btn.appendChild(ico);
                    }
                    btn.appendChild(lbl);
                    // Events
                    // Mouse
                    btn.addEventListener("mousedown", (e) => {
                        e.preventDefault();
                        handleBtnPress(i);
                    });
                    btn.addEventListener("mouseup", (e) => {
                        e.preventDefault();
                        handleBtnRelease(i);
                    });
                    btn.addEventListener("mouseleave", (e) => {
                        e.preventDefault();
                        handleBtnRelease(i);
                    });
                    // Touch
                    btn.addEventListener("touchstart", (e) => {
                        e.preventDefault(); // Prevent scroll/zoom
                        handleBtnPress(i);
                    });
                    btn.addEventListener("touchend", (e) => {
                        e.preventDefault();
                        handleBtnRelease(i);
                    });
                    grid.appendChild(btn);
                }
            }
            // Init
            renderKeypadGrid();
            updateStatus(false);
            updateFeedbackUI(); // Set Init UI State
        </script>
    </div>
</body>
</html>
